var db = require('controllers/database');
var mongoose = require('mongoose');
var users = mongoose.model('users');
var encryption	= require('../../route/encryption');
var crypto = require('crypto');
var rand = require('csprng');

exports.signup = function(picture,fname,lname,gender,dateN,country,city,email,password,phone,driver,callback){
  var temp = rand(160,36);
  var hashed_password = crypto.createHash('sha512').update(temp + password).digest("hex");
  var newUser = new users({fname:fname,lname:lname,gender:gender,dateN:dateN,country:country,city:city,
    email:email,password:hashed_password,phone:phone,driver:driver,picture:picture,
    ptd:0,pttd:0,
		ptc:0,pttc:0,
		pte:0,ptte:0,
    ptp:0,pttp:0,
    connected:false,salt:temp });
  users.find({email:email},function(err,data){
    if(data.length == 0){
      newUser.save(function(err){
          if(err){
            callback({'res':false,'response':"Error Users, you have not added a new user."});
          }else{
            callback({'res':true,'response':"Successfully Users, you have added a new user."});
          }
        });
    }else{
      callback({'res':false,'response':"Error Users, Email already registered."});
    }
  });

exports.login = function(email,password,callback){
  clients.find({email: email},function(err,data){
    if(data.length != null){
      var token = data[0]._id;
      var fname = data[0].fname;
      var lname = data[0].lname;
      var country = data[0].country;
      var picture = data[0].picture;
      var hash_db = data[0].password;
      var temp = data[0].salt;
      var connected = data[0].connected;
      var hashed_password = crypto.createHash('sha512').update(temp + password).digest("hex");
      if(hash_db == hashed_password){
        if(!connected){
          var keyVitual = encryption.keyVirtual();
          var key = encryption.key(keyVitual);
          users.update({_id:token},{$set:{connected:true}},{multi:true},function(err){
            if(err){
              callback({'res':false,'response':"Error Users, you have not connected this user."});
            }else{
              callback({'res':true,'response':"Successfully Users, login.",'key':keyVitual,
                'token':token,'fname':encryption.encode(fname,key),'lname':encryption.encode(lname,key),
                'country':encryption.encode(country,key),'picture':picture});
            }
          });
        }else{
          callback({'res':false,'response':"Error Users, the user is logged into another device."});
        }
      }else{
        callback({'res':false,'response':"Error Users, invalid password."});
      }
    }else{
      callback({'res':false,'response':"Error Users, user not exist."});
    }
  });
}

exports.profile = function(token,callback){
  clients.find({_id:token},function(err,data){
    if(data.length != 0){
      var fname = data[0].fname;
      var lname = data[0].lname;
      var gender = data[0].gender;
      var dateN = data[0].dateN;
      var country = data[0].country;
      var city = data[0].city;
      var email = data[0].email;
      var phone = data[0].phone;
      var picture = data[0].picture;
      var keyVitual = encryption.keyVirtual();
      var key = encryption.key(keyVitual);
      callback({'res':true,'key':keyVitual,'fname':encryption.encode(fname,key),'lname':encryption.encode(lname,key),
        'gender':encryption.encode(gender,key),'dateN':encryption.encode(dateN,key),'country':encryption.encode(country,key),
        'city':encryption.encode(city,key),'email':encryption.encode(email,key),'phone':encryption.encode(phone,key),
        'picture':picture});
    }else{
      callback({'res':false});
    }
  });
}

exports.logout = function(token,callback){
  clients.update({_id:token},{$set:{connected:false}},{multi:true},function(err){
    if(err){
      callback({'res':false});
    }else{
      callback({'res':true});
    }
  });
}
}
